<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
      * { box-sizing: border-box; }

      body {
        font-family: 'Poppins', sans-serif;
        margin: 0; height: 100vh; overflow: hidden;
        display: flex; align-items: center; justify-content: center;
        background: linear-gradient(135deg, #00b4d8, #0077b6, #90e0ef);
        background-size: 300% 300%;
        animation: gradientShift 10s ease infinite;
        color: white;
      }

      @keyframes gradientShift { 0% {background-position:0%50%;} 50% {background-position:100%50%;} 100% {background-position:0%50%;} }

      .container {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 40px 30px;
        width: 90%; max-width: 420px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(31,38,135,0.37);
        animation: fadeIn 1.5s ease; position: relative;
      }

      @keyframes fadeIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

      h1 { font-size: 24px; margin-bottom: 10px; letter-spacing: 0.5px; }
      h3 { font-weight: 500; margin-bottom: 25px; color: #e3f2fd; }

      input, select {
        width: 90%; padding: 12px; margin: 10px 0; border: none; border-radius: 10px;
        outline: none; background: rgba(255,255,255,0.9); font-size: 15px; text-align: center;
        transition: 0.3s;
      }
      input:focus, select:focus { box-shadow: 0 0 12px rgba(0,183,255,0.8); transform: scale(1.02); }

      button {
        position: relative; overflow: hidden; width: 90%; padding: 12px; border: none;
        border-radius: 10px; background: linear-gradient(135deg,#00b4d8,#0077b6);
        color:white; font-size:16px; font-weight:600; cursor:pointer; margin-top:15px;
        transition: all 0.3s ease; box-shadow: 0 0 15px rgba(0,183,255,0.5);
      }
      button:hover { transform: scale(1.05); box-shadow:0 0 25px rgba(0,183,255,0.9); }
      button::after {
        content:""; position:absolute; left:50%; top:50%; width:0; height:0;
        background: rgba(255,255,255,0.3); border-radius:50%;
        transform:translate(-50%,-50%); transition: width 0.6s ease, height 0.6s ease;
      }
      button:active::after { width:300px; height:300px; }

      #msg {
        margin-top:25px;
        font-weight:500;
        color:#e0f7fa;
        font-size:15px;
        text-align:center;
        line-height:1.8;
        opacity:0;
        transform:translateY(10px);
        transition: all 0.6s ease;
      }

      #msg.show {
        opacity:1;
        transform:translateY(0);
      }

      #msg strong {
        display:block;
        font-size:16px;
        margin-bottom:10px;
        letter-spacing:0.3px;
      }

      #msg.success strong { color:#00ffc8; }
      #msg.warning strong { color:#ffd600; }
      #msg.error strong { color:#ff6b6b; }

      .detail-line {
        font-size: 15px;
        color: #ccfaff;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px 20px;
      }

      .detail-line span { white-space: nowrap; }

      #clock {
        position:absolute; top:20px; right:25px;
        background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
        padding: 8px 15px; border-radius: 12px; font-size:14px; font-weight:500;
        color:#e0f7fa; box-shadow:0 0 10px rgba(0,0,0,0.1);
        animation: floatClock 4s ease-in-out infinite;
      }
      @keyframes floatClock { 0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);} }

      canvas#confetti {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0; /* ‚úÖ moved behind the form */
      }

      /* Date fields side-by-side */
      #leave-dates {
        display: none;
        width: 90%;
        margin: 10px auto;
        justify-content: center;
        gap: 10px;
      }
      #leave-dates input {
        width: 48%;
        margin: 0;
      }

      /* ‚úÖ Loader fix: appears below form, not overlapping */
      .loader {
        display: none;
        justify-content: center;
        align-items: center;
        gap: 6px;
        margin-top: 12px;
        position: relative;
      }

      .loader div {
        width: 8px;
        height: 8px;
        background-color: white;
        border-radius: 50%;
        animation: bounce 0.6s infinite alternate;
      }

      .loader div:nth-child(2) {
        animation-delay: 0.2s;
      }

      .loader div:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes bounce {
        to {
          transform: translateY(-6px);
          opacity: 0.6;
        }
      }
    </style>
  </head>

  <body>
    <canvas id="confetti"></canvas>
    <div class="container">
      <div id="clock"></div>
      <h1>Attendance System For ISD</h1>
      <h3>Mark Your Attendance</h3>

      <input type="text" id="username" placeholder="Enter your Username" required>

      <select id="status" onchange="toggleLeaveDates()">
        <option value="Present">Present</option>
        <option value="Leave">Leave</option>
      </select>

      <div id="leave-dates">
        <input type="date" id="fromDate">
        <input type="date" id="toDate">
      </div>

      <button onclick="markAttendance()">Submit</button>

      <!-- ‚úÖ Loader placed below the form -->
      <div class="loader" id="loader">
        <div></div><div></div><div></div>
      </div>

      <div id="msg"></div>
    </div>

    <script>
      // Clock
      function updateClock() {
        const now = new Date();
        const date = now.toLocaleDateString('en-GB', { weekday:'short', year:'numeric', month:'short', day:'numeric' });
        const time = now.toLocaleTimeString();
        document.getElementById('clock').innerHTML = `${date} | ${time}`;
      }
      setInterval(updateClock,1000); updateClock();

      // Confetti
      function launchConfetti() {
        const canvas = document.getElementById('confetti');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const confetti = Array.from({length:120}).map(() => ({
          x: Math.random()*canvas.width,
          y: Math.random()*canvas.height - canvas.height,
          r: Math.random()*6 + 2,
          d: Math.random()*0.5 + 0.5,
          color: `hsl(${Math.random()*360},100%,70%)`
        }));
        function draw() {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          confetti.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
            ctx.fillStyle = p.color;
            ctx.fill();
          });
          confetti.forEach(p => {
            p.y += p.d * 4;
            if (p.y > canvas.height) { p.y = -10; p.x = Math.random()*canvas.width; }
          });
        }
        let animation = setInterval(draw,20);
        setTimeout(()=>clearInterval(animation),3000);
      }

      // Show/hide leave date inputs
      function toggleLeaveDates() {
        const status = document.getElementById("status").value;
        document.getElementById("leave-dates").style.display = (status === "Leave") ? "flex" : "none";
      }

      // Run once on page load to hide leave fields if not needed
      window.onload = toggleLeaveDates;

      // Show messages
      function showMessage(type, mainText, details = {}) {
        const msg = document.getElementById("msg");
        msg.className = "";
        msg.classList.add("show", type);

        let detailsHTML = "";
        if (type === "success") {
          detailsHTML = `
            <div class="detail-line">
              <span>üë§ Name: ${details.Name || "N/A"}</span>
              <span>üíº Designation: ${details.Designation || "N/A"}</span>
            </div>
            <div class="detail-line">
              <span>üè¢ Organization: ${details.Organization || "ISD"}</span>
              <span>üìç District: ${details.District || "N/A"}</span>
            </div>
          `;
        }

        msg.innerHTML = `<strong>${mainText}</strong>${detailsHTML}`;
      }

      // Mark attendance
      function markAttendance() {
        const username = document.getElementById('username').value.trim();
        const status = document.getElementById('status').value;
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;

        if (!username) {
          showMessage("error", "‚ö†Ô∏è Please enter your Username!");
          return;
        }
        if (status === "Leave" && (!fromDate || !toDate)) {
          showMessage("error", "‚ö†Ô∏è Please select both From and To dates for Leave!");
          return;
        }

        navigator.geolocation.getCurrentPosition(async position => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          const data = { username, status, fromDate, toDate, latitude, longitude };

          const btn = document.querySelector("button");
          const loader = document.getElementById("loader");
          btn.disabled = true;
          btn.innerText = "Submitting...";
          loader.style.display = "flex"; // ‚úÖ show loader below form

          try {
            google.script.run.withSuccessHandler(result => {
              btn.disabled = false;
              btn.innerText = "Submit";
              loader.style.display = "none"; // ‚úÖ hide loader

              if (result.status === "success") {
                launchConfetti();
                showMessage("success", "‚úÖ Successfully Submitted!", result.details);
              } 
              else if (result.status === "warning") {
                showMessage("warning", result.message);
              } 
              else {
                showMessage("error", result.message);
              }
            }).recordAttendance(data);
          } catch (e) {
            loader.style.display = "none";
            showMessage("error", "‚ö†Ô∏è Something went wrong!");
          }

        }, () => {
          showMessage("error", "‚ö†Ô∏è Location access denied. Please enable GPS.");
        });
      }
    </script>
  </body>
</html>
